# Shai-Hulud 2.0 攻撃を受けての反省と対策

「乗っ取られてる？」友人から連絡が届いた。
同時に送られていたスクリーンショットを見ると、私のアカウント名義で大量のcommitがpushされていた。

慌ててGitHubを確認すると、自分のアカウントから身に覚えのない変更が大量に作成されていた。

![GitHubのcommit履歴のスクリーンショット。様々なリポジトリに対して複数のcommitが作成されている。](./history.png)

わけもわからないまま関係者への連絡、GitHubのパスワード変更、APIキーの無効化などその場でできる限りの対応を行った。

## 何が起こったのか？

調査の結果、[Shai-hulud 2.0](https://www.trendmicro.com/ja_jp/research/25/k/shai-hulud-2-0-targets-cloud-and-developer-systems.html)と呼ばれるnpmサプライチェーン攻撃の被害を受けていたことがわかった。

実際に私が受けた被害は以下の通り。

- GitHubアカウントが乗っ取られ、悪意のある変更が加えられた
  - アクセス権のある全リポジトリのREADMEが改ざんされた（[同様の被害報告](https://github.com/orgs/community/discussions/180432)）
  - privateリポジトリがpublicに変更された
- 自分のアカウントに新しいリポジトリが作成され、環境変数やAPIキーなどの機密情報が外部から閲覧可能な状態で公開された

### Shai-hulud 2.0とは

Shai-hulud 2.0の攻撃メカニズムは以下のようになっている。

1. 正規のnpmパッケージメンテナーの認証情報を不正入手し、アカウントを乗っ取る
2. 乗っ取ったアカウントを使って人気パッケージをトロイの木馬化する
3. 感染パッケージがインストールされると、preinstallスクリプトでマルウェアが自動実行される
4. マルウェアはexfiltration用のリポジトリを作成し、環境内のシークレットをpushする
5. 盗んだnpmトークンを使ってパッケージの不正バージョンを公開し、さらに被害を拡大する

### 私の感染経路

私の場合、npm経由ではなくVSCode拡張機能経由での感染だった。

2年ほど前の開発で導入した拡張機能「vs-asyncapi-preview」に、悪意のあるバージョンがpushされていた。Cursorを起動した際、拡張機能が自動アップデートされるタイミングで感染したと考えられる。

詳細については、[AsyncAPI公式ブログのポストモーテム記事](https://www.asyncapi.com/blog/shai-hulud-postmortem)で解説されている。

## 攻撃を受けての反省

npmサプライチェーン攻撃については、会社でも情報共有されており知識としては知っていた。しかし、自分個人には関係のない話だろうと高をくくってしまっていた。

そんな自分が実際に攻撃を受け、過去に一緒に開発したメンバーや所属しているOrganizationのメンバーにまで迷惑をかけることになってしまった。

そこで、自分のエンジニアとしての技術力の無さと意識の低さが露呈した。

- CLIに慣れておらず、どう調査するべきかも手探りな状態でなんとか原因を特定した
- トークンの保存場所すら把握できていないなど、普段の管理が杜撰だった
- 対応策をなんとなく知っていても、実践はしておらず、何も身についていなかった

この経験を真摯に受け止め、自分のセキュリティ周りを見直すことにした。

## 行った対策

### 1. dev containerの導入

今回の感染の根本原因は、**PC全体に影響が及ぶグローバルな環境で開発していた**ことにあった。

実際、2年前のプロジェクトで使った「vs-asyncapi-preview」という拡張機能を放置していたことで、全プロジェクトに影響が及んだ。これは拡張機能経由での感染だったが、Shai-Hulud 2.0の本来の攻撃経路であるnpm経由の場合も同様である。

ホストマシンのターミナルで直接`npm install`を実行すると、先述した攻撃メカニズムの通り、preinstallスクリプトが自動実行される。悪意のあるパッケージが含まれていた場合、環境変数に保存された全プロジェクトの機密情報（GitHubトークン、AWSクレデンシャル等）が一度に流出してしまう。

この問題を解決するために、**開発環境の分離（Isolation）**を徹底する。

dev containerを導入することで、プロジェクトごとに独立したコンテナ環境を構築する。これにより以下が実現できる：

- **影響範囲の限定化**: 万が一攻撃を受けても、被害はそのコンテナ内に閉じ込められる
- **プロジェクト固有の依存関係管理**: 拡張機能やツールをプロジェクトごとに管理できる

今回の経験を機に、今後のあらゆる開発でDev Containerを使用することにした。これまでコンテナ技術にしっかりと向き合ってこなかったため、学び直しとしてdev containerの具体的な設定方法に関して改めて記事にする予定だ。

### 2. pnpmの設定見直し

### 3. クレデンシャルの秘匿

## まとめ

対策を行うことで、なんと無く聞いたことがあった知識を自分の経験にすることにでき、自分も成長できた。
めんどくさいからといって、管理を杜撰にしていたことが自分の成長の機会を奪っていたことに気がついた

今後はメリットのあるものをどんどん活用していき、多角的な知識をしっかりつけるようにしたいと思った。


## 参考

- [Shai-hulud 2.0キャンペーンがクラウドと開発者エコシステムを標的に](https://www.trendmicro.com/ja_jp/research/25/k/shai-hulud-2-0-targets-cloud-and-developer-systems.html)
- [Shai-Hulud — What Happened, How We Fixed It, and What We Learned](https://www.asyncapi.com/blog/shai-hulud-postmortem)